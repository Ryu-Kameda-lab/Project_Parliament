<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Parliament</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+1p:wght@400;500;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.min.js"></script>
</head>
<body>
    <div class="app-container">

        <!-- ===== 左サイドバー（AIアイコン＋稼働状況） ===== -->
        <aside class="sidebar">
            <div class="sidebar-logo" title="Project Parliament">
                <div class="logo-icon">🏛️</div>
            </div>

            <nav class="ai-nav">
                {% for ai_id, profile in ai_profiles.items() %}
                <div class="ai-slot" id="slot-{{ ai_id }}" data-ai-id="{{ ai_id }}" 
                     title="{{ profile.name }} - {{ profile.role }}">
                    <div class="ai-avatar" style="--ai-color: {{ profile.avatar_color }}">
                        <span class="ai-icon">{{ profile.icon }}</span>
                        <span class="status-indicator offline" id="indicator-{{ ai_id }}"></span>
                    </div>
                    <span class="ai-label">{{ profile.name }}</span>
                </div>
                {% endfor %}
            </nav>

            <div class="sidebar-bottom">
                <div class="ai-slot" title="設定">
                    <div class="ai-avatar" style="--ai-color: #64748b">
                        <span class="ai-icon">⚙️</span>
                    </div>
                </div>
            </div>
        </aside>

        <!-- ===== メインエリア ===== -->
        <div class="main-area">

            <!-- 上部：日付 + ステータスバー -->
            <header class="top-bar">
                <div class="top-left">
                    <span class="header-date" id="headerDate"></span>
                </div>
                <div class="top-center">
                    <div class="status-chip" id="statusChip" data-status="waiting">
                        <span class="status-pulse" id="statusPulse"></span>
                        <span class="status-text" id="statusText">AI起動待ち</span>
                    </div>
                </div>
                <div class="top-right">
                    <span class="online-badge" id="onlineBadge">
                        <span class="online-dot"></span> 0 / 4
                    </span>
                </div>
            </header>

            <!-- 中央：チャットエリア -->
            <div class="chat-area" id="chatArea">
                <!-- 日付区切り -->
                <div class="date-divider">
                    <span id="chatDateLabel"></span>
                </div>

                <!-- ウェルカムメッセージ -->
                <div class="system-bubble welcome">
                    <div class="system-inner">
                        <span class="sys-icon">🏛️</span>
                        <span class="sys-text">
                            <strong>Project Parliament</strong> — 
                            全AIを起動し、チャート画像をアップロードして議論を開始してください
                        </span>
                    </div>
                </div>
            </div>

            <!-- 下部：コントロールバー -->
            <div class="control-bar">

                <!-- フェーズ1: AI起動 -->
                <div class="ctrl-phase" id="phaseActivate">
                    <button class="ctrl-btn primary" id="btnActivateAll" onclick="activateAllAI()">
                        <span class="cb-icon">⚡</span> 全AIを起動
                    </button>
                </div>

                <!-- フェーズ2: 画像アップロード＋開始 -->
                <div class="ctrl-phase" id="phaseUpload" style="display:none">
                    <div class="upload-strip" id="previewStrip"></div>
                    <div class="ctrl-row">
                        <input type="file" id="chartInput" multiple accept="image/*"
                               onchange="handleFileSelect(event)" style="display:none">
                        <button class="ctrl-btn secondary" onclick="document.getElementById('chartInput').click()">
                            <span class="cb-icon">📊</span> 画像を選択
                            <span class="file-count" id="fileCount" style="display:none">0</span>
                        </button>
                        <button class="ctrl-btn accent" id="btnStart" onclick="startDiscussion()" disabled>
                            <span class="cb-icon">🚀</span> 議論を開始
                        </button>
                    </div>
                </div>

                <!-- フェーズ3: 議論進行中 -->
                <div class="ctrl-phase" id="phaseRunning" style="display:none">
                    <div class="ctrl-row">
                        <div class="typing-box" id="typingBox">
                            <div class="typing-dots"><span></span><span></span><span></span></div>
                            <span class="typing-who" id="typingWho">AIが分析中...</span>
                        </div>
                        <button class="ctrl-btn danger" onclick="stopDiscussion()">
                            <span class="cb-icon">⏹</span> 強制終了
                        </button>
                    </div>
                </div>

                <!-- フェーズ4: 完了 -->
                <div class="ctrl-phase" id="phaseComplete" style="display:none">
                    <div class="ctrl-row">
                        <button class="ctrl-btn download" id="btnDownload" onclick="downloadReport()">
                            <span class="cb-icon">📥</span> 稟議書をダウンロード
                        </button>
                        <button class="ctrl-btn ghost" onclick="stopDiscussion()">
                            <span class="cb-icon">🔄</span> 新しい議論
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ===== 右パネル：稟議書＋投票状況 ===== -->
        <aside class="right-panel" id="rightPanel">
            <div class="rpanel-head">
                <h3>📋 稟議書</h3>
                <span class="rpanel-badge" id="rpanelBadge">待機中</span>
            </div>
            <div class="rpanel-body" id="rpanelBody">
                <div class="rpanel-empty">
                    <div class="empty-icon">📋</div>
                    <p>AIが稟議書を提出すると<br>ここに表示されます</p>
                </div>
            </div>
            <div class="vote-board" id="voteBoard">
                <h4 class="vote-title">投票状況</h4>
                {% for ai_id, profile in ai_profiles.items() %}
                <div class="vote-row" id="voteRow-{{ ai_id }}">
                    <span class="vr-avatar" style="background:{{ profile.avatar_color }}">{{ profile.icon }}</span>
                    <span class="vr-name">{{ profile.name }}</span>
                    <span class="vr-result" id="voteResult-{{ ai_id }}">—</span>
                </div>
                {% endfor %}
            </div>
        </aside>
    </div>

    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
</body>
</html>
