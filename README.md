# Project Parliament — 要件定義書 v2.0

> **バージョン:** 2.0  
> **作成日:** 2026年2月10日  
> **ステータス:** 開発中（Step 1-2 完了）  
> **変更概要:** アンサンブル推論・マルチモデル合議アーキテクチャの導入

---

## 1. プロジェクト概要

### 1.1 サービス概要

Project Parliament は、複数の AI サービスを 1 つの Web インターフェース上で連結し、仮想通貨取引のチャート画像を分析・議論させるサービスである。

**v2.0 での根本的変更点:**  
「アンサンブル推論」「マルチモデル合議」を導入し、ChatGPT と Gemini については **各 7 体** の個体で内部合議を行い、多角的な分析精度と結論の堅牢性を向上させる。ただし最終的な意思決定（稟議・投票）は **各陣営のまとめ役（1 体）のみ** に限定し、意思決定の一貫性と監査可能性を担保する。

### 1.2 プロジェクト情報

| 項目 | 内容 |
|------|------|
| プロジェクト名 | Project Parliament |
| 開発言語 | Python (Flask), HTML/CSS/JavaScript |
| 利用者 | 1 名（管理人のみ） |
| 利用目的 | 仮想通貨取引チャートの分析・戦略策定支援 |
| AI 総数 | **16 体**（ChatGPT×7, Gemini×7, Codex×1, Claude×1） |
| 意思決定権保有数 | **4 体**（各陣営のまとめ役のみ） |
| 開発環境 | GitHub 上で管理 |

### 1.3 重要な制約事項

- **議論データの保管は一切行わない** — サービス終了の度に全データを破棄
- **AI は実際の取引を行わない** — 最終的な取引判断はユーザーが行う
- **チャート画像は最大 5 枚まで**
- **意思決定権の分離** — 議論参加と決裁権を厳格に分離する

---

## 2. アンサンブル推論アーキテクチャ

### 2.1 AI 体制構成（全 16 体）

```
┌─────────────────────────────────────────────────────────┐
│                  Project Parliament                      │
│                                                         │
│  ┌──────────────────┐    ┌──────────────────┐          │
│  │  ChatGPT 陣営     │    │  Gemini 陣営      │          │
│  │  (gpt-4o × 7)    │    │  (gemini-2.0 × 7)│          │
│  │                  │    │                  │          │
│  │  👑 まとめ役 ×1   │    │  👑 まとめ役 ×1   │          │
│  │  🔍 調査役   ×3   │    │  🔍 調査役   ×3   │          │
│  │  🛡️ 監査役   ×3   │    │  🛡️ 監査役   ×3   │          │
│  └────────┬─────────┘    └────────┬─────────┘          │
│           │                       │                     │
│           ▼                       ▼                     │
│  ┌────────────────────────────────────────────┐        │
│  │           中央チャット（議場）               │        │
│  │    まとめ役のみが稟議・投票を行う            │        │
│  └────────────────────────────────────────────┘        │
│           ▲                       ▲                     │
│           │                       │                     │
│  ┌────────┴─────────┐    ┌────────┴─────────┐          │
│  │  Codex (1体)      │    │  Claude (1体)     │          │
│  │  データ分析専門    │    │  リスク管理専門    │          │
│  │  ※ 決裁権あり      │    │  ※ 決裁権あり      │          │
│  └──────────────────┘    └──────────────────┘          │
└─────────────────────────────────────────────────────────┘
```

### 2.2 ChatGPT / Gemini 陣営の内部構成（同一構造）

各陣営は 7 体で構成され、3 つの役割に分かれる。

| 役割 | 体数 | ID例（ChatGPT陣営） | 権限 |
|------|------|---------------------|------|
| **まとめ役（リーダー）** | 1 | `chatgpt-leader` | 論点整理、根拠採用、稟議提出、投票 **※決裁権あり** |
| **調査・提案役（ワーカー）** | 3 | `chatgpt-worker-1`〜`3` | 多角的な戦略提案（性能優先/コスト優先/リスク優先 等） **※議論参加のみ** |
| **監査・反証役（クリティック）** | 3 | `chatgpt-critic-1`〜`3` | 前提の抜け・反例・リスク指摘 **※議論参加のみ** |

### 2.3 意思決定ルール

#### 2.3.1 「議論参加」と「決裁権」の分離

| 権限 | まとめ役 | 調査役 | 監査役 | Codex | Claude |
|------|---------|--------|--------|-------|--------|
| チャットでの発言 | ✅ | ✅ | ✅ | ✅ | ✅ |
| 稟議書の提出 | ✅ | ❌ | ❌ | ✅ | ✅ |
| 投票（賛成/反対） | ✅ | ❌ | ❌ | ✅ | ✅ |

**狙い:**
- 多人数合議で起きがちな「結論が散る」「責任が曖昧」を回避
- "出力責任"を一本化し、説明可能性を確保

#### 2.3.2 まとめ役の意思決定方式：「根拠採用制」

まとめ役は **多数決ではなく「根拠採用制」** で結論を導く。

```
Step A: 調査役の根拠を比較 ── 3つの提案の論拠を並列評価
Step B: 監査役の反証を確認 ── 各提案の弱点・反例を検証
Step C: 採用理由を明文化 ── なぜこの案を採用し、他を不採用としたか記述
Step D: 稟議・投票 ── 必要に応じて中央チャットに稟議書を提出
```

**効果:** 「AIが勝手に多数決した」ではなく、**"根拠が通った案が採用された"** という監査可能な意思決定になる。

---

## 3. 業務フロー

### 3.1 議論フロー（5 ステップ）

| Step | フェーズ | 実行者 | 内容 |
|------|---------|--------|------|
| **1** | 論点整理 | 各陣営まとめ役 | 入力（チャート画像、要件）を整理し、分析の問いを定義 |
| **2** | 調査・提案 | 調査役×3（並列） | それぞれ視点を変えて提案（例：テクニカル優先/ファンダメンタルズ優先/リスク優先） |
| **3** | 監査・反証 | 監査役×3（並列） | 前提の抜け・要件違反・反例・リスクを指摘。「この案はこの条件では破綻する」を明確化 |
| **4** | 横断チェック | Codex + Claude | Codex：データ分析・定量的妥当性チェック。Claude：論理整合・見落とし指摘・別系統の観点で補完 |
| **5** | 結論確定 | 各陣営まとめ役 | 採用案＋理由＋保留点を確定。稟議・投票は、まとめ役が最終手続きを担当 |

### 3.2 全体業務フロー（ユーザー操作含む）

| Step | 操作 | 詳細 |
|------|------|------|
| 1 | AI 起動 | ユーザーがボタンクリックで全 16 体の AI を起動。各 API に接続確認。 |
| 2 | 議論開始 | 全 AI オンライン後、チャート画像（最大 5 枚）をアップロードし議論開始。 |
| 3 | 陣営内合議 | ChatGPT 陣営・Gemini 陣営がそれぞれ内部で調査→監査→まとめの合議を実施。 |
| 4 | 中央議論 | 4 名の決裁権者（ChatGPT リーダー、Gemini リーダー、Codex、Claude）が中央チャットで議論。 |
| 5 | 稟議書提出 | 決裁権者が取引戦略を稟議書として提出。根拠と採用理由を明記。 |
| 6 | 投票 | 他の決裁権者 3 名が「賛成」または「反対」を表明。 |
| 7 | 満場一致承認 | 全決裁権者が賛成 → ブラッシュアップフェーズへ移行。 |
| 8 | 最終稟議書 | 全 AI でブラッシュアップを行い、最終版をユーザーに報告。 |
| 9 | 終了 | ユーザーが稟議書をダウンロードした時点で全データ破棄・サービス停止。 |

### 3.3 ステータス遷移

| ステータス | 表示色 | 条件 |
|-----------|--------|------|
| AI 起動待ち | グレー (#f1f5f9) | 初期状態 |
| AI 待機中 | ブルー (#dbeafe) | 全 16 体がオンライン |
| 陣営内合議中 | シアン (#cffafe) | 各陣営が内部合議を実施中 |
| 議論中 | グリーン (#dcfce7) | 決裁権者 4 名が中央チャットで議論中 |
| 投票中 | オレンジ (#fef3c7) | 稟議書が提出され投票進行中 |
| 稟議審査中 | パープル (#ede9fe) | 満場一致承認後、ブラッシュアップ中 |
| 稟議書提出済み | グリーン (#d1fae5) | 最終稟議書完成、ダウンロード可能 |

---

## 4. システム構成

### 4.1 技術スタック

| カテゴリ | 技術 | 用途 |
|---------|------|------|
| バックエンド | Python 3.11+ / Flask | Web サーバー、API、ビジネスロジック |
| リアルタイム通信 | Flask-SocketIO (WebSocket) | チャットメッセージのリアルタイム配信 |
| フロントエンド | HTML / CSS / JavaScript | UI 表示、ユーザー操作、Socket.IO 通信 |
| AI (ChatGPT ×7) | OpenAI API (gpt-4o) | テクニカル分析陣営（リーダー×1, ワーカー×3, クリティック×3） |
| AI (Gemini ×7) | Google AI API (gemini-2.0-flash) | マクロ経済分析陣営（リーダー×1, ワーカー×3, クリティック×3） |
| AI (Codex ×1) | OpenAI API (gpt-4o-mini) | データ分析・定量分析の専門家 |
| AI (Claude ×1) | Anthropic API (claude-sonnet-4-20250514) | リスク管理・総合判断の専門家 |

### 4.2 ファイル構成

```
Project_Parliament/
├── app.py                       # Flask メインアプリケーション
├── config.py                    # 設定・AIプロフィール定義
├── requirements.txt             # Python パッケージ依存関係
├── .env / .env.example          # 環境変数（APIキー）
├── modules/
│   ├── __init__.py
│   ├── ai_clients.py            # AI 接続クライアント（16体分のインスタンス管理）
│   ├── discussion_engine.py     # 中央議論エンジン
│   └── ensemble_engine.py       # 【新規】陣営内合議エンジン（アンサンブル推論）
├── templates/
│   └── index.html               # メイン UI
├── static/
│   ├── css/style.css            # スタイルシート
│   ├── js/main.js               # フロントエンド JS
│   └── images/
└── README.md
```

### 4.3 AI インスタンス ID 一覧

| 陣営 | ID | 役割 | モデル | 決裁権 |
|------|-----|------|--------|--------|
| ChatGPT | `chatgpt-leader` | まとめ役（リーダー） | gpt-4o | ✅ |
| ChatGPT | `chatgpt-worker-1` | 調査・提案役 #1 | gpt-4o | ❌ |
| ChatGPT | `chatgpt-worker-2` | 調査・提案役 #2 | gpt-4o | ❌ |
| ChatGPT | `chatgpt-worker-3` | 調査・提案役 #3 | gpt-4o | ❌ |
| ChatGPT | `chatgpt-critic-1` | 監査・反証役 #1 | gpt-4o | ❌ |
| ChatGPT | `chatgpt-critic-2` | 監査・反証役 #2 | gpt-4o | ❌ |
| ChatGPT | `chatgpt-critic-3` | 監査・反証役 #3 | gpt-4o | ❌ |
| Gemini | `gemini-leader` | まとめ役（リーダー） | gemini-2.0-flash | ✅ |
| Gemini | `gemini-worker-1` | 調査・提案役 #1 | gemini-2.0-flash | ❌ |
| Gemini | `gemini-worker-2` | 調査・提案役 #2 | gemini-2.0-flash | ❌ |
| Gemini | `gemini-worker-3` | 調査・提案役 #3 | gemini-2.0-flash | ❌ |
| Gemini | `gemini-critic-1` | 監査・反証役 #1 | gemini-2.0-flash | ❌ |
| Gemini | `gemini-critic-2` | 監査・反証役 #2 | gemini-2.0-flash | ❌ |
| Gemini | `gemini-critic-3` | 監査・反証役 #3 | gemini-2.0-flash | ❌ |
| Codex | `codex` | データ分析専門家 | gpt-4o-mini | ✅ |
| Claude | `claude` | リスク管理専門家 | claude-sonnet-4-20250514 | ✅ |

---

## 5. UI/UX 仕様

### 5.1 画面レイアウト

| 領域 | 幅 | 内容 |
|------|-----|------|
| 左サイドバー | 72px（固定） | ダークネイビー背景。**4 陣営** のアイコン（ChatGPT/Gemini/Codex/Claude）とオンライン状態。陣営アイコンクリックで内部メンバーの稼働状況をポップアップ表示。 |
| メインエリア | 残り幅（可変） | 上部：日付＋ステータスチップ＋オンライン数（`X/16`）。中央：チャットメッセージエリア。下部：コントロールバー。 |
| 右パネル | 300px（固定） | 稟議書全文表示＋ **決裁権者 4 名** の投票状況ボード。 |

### 5.2 チャットメッセージの表示

中央チャットには **全 16 体** の発言が表示される。役割に応じてバッジで区別する。

| メッセージ種別 | 外観 | バッジ |
|---------------|------|--------|
| まとめ役の発言 | アバター＋名前（太字）＋時刻 | 👑 **リーダー** |
| 調査役の発言 | アバター＋名前＋時刻（やや小さめ） | 🔍 調査役 |
| 監査役の発言 | アバター＋名前＋時刻（やや小さめ） | 🛡️ 監査役 |
| Codex / Claude の発言 | アバター＋名前＋時刻 | （バッジなし） |
| 稟議書メッセージ | 黄色背景＋左オレンジ太線 | 📋 **稟議書**（決裁権者のみ投稿可） |
| システムメッセージ | 薄緑ピル型、中央配置 | — |

### 5.3 コントロールバーのフェーズ

| フェーズ | 表示要素 | 動作 |
|---------|---------|------|
| Phase 1 | 「全 AI を起動」ボタン | 16 体を順次起動。完了で Phase 2 へ。 |
| Phase 2 | 「画像を選択」「議論を開始」ボタン＋プレビュー | チャート画像アップロード後に議論開始。 |
| Phase 3 | タイピングアニメーション＋「強制終了」ボタン | どの AI（役割含む）が入力中か表示。 |
| Phase 4 | 「稟議書をダウンロード」「新しい議論」ボタン | DL 後にセッション自動リセット。 |

### 5.4 カラーパレット

| 用途 | カラーコード | 備考 |
|------|------------|------|
| ページ背景 | #f0f2f5 | 薄いグレー |
| サイドバー背景 | #1e293b | ダークネイビー |
| チャットエリア背景 | #ffffff | ホワイト |
| アクセント | #3b82f6 | ブルー |
| ChatGPT 陣営 | #10a37f | OpenAI グリーン |
| Gemini 陣営 | #4285f4 | Google ブルー |
| Codex | #f97316 | オレンジ |
| Claude | #d97706 | アンバー |
| 調査役バッジ | #0ea5e9 | スカイブルー |
| 監査役バッジ | #ef4444 | レッド |

---

## 6. API 仕様

### 6.1 REST API エンドポイント

| メソッド | エンドポイント | 説明 |
|---------|---------------|------|
| GET | `/` | メイン画面表示 |
| POST | `/api/ai/activate` | 個別 AI を起動。Body: `{"ai_id": "chatgpt-leader"}` |
| POST | `/api/ai/activate-all` | 全 16 体を一括起動 |
| GET | `/api/ai/status` | 全 AI の接続状態を取得（16 体分） |
| POST | `/api/discussion/start` | 議論開始（multipart/form-data で画像送信） |
| POST | `/api/discussion/stop` | 議論停止・全データ破棄 |
| GET | `/api/report/download` | 最終稟議書をダウンロード |

### 6.2 WebSocket イベント

| 方向 | イベント名 | 説明 |
|------|-----------|------|
| Server → Client | `ai_status_update` | AI 接続状態の変化（16 体分） |
| Server → Client | `new_message` | 新チャットメッセージ `{id, sender, role, faction, content, timestamp, type}` |
| Server → Client | `typing` | AI 入力中通知 `{ai_id, role, faction}` |
| Server → Client | `ensemble_phase` | 陣営内合議のフェーズ通知 `{faction, phase}` |
| Server → Client | `proposal_update` | 稟議書状態更新 `{status, content, author, votes}` |
| Server → Client | `final_report_ready` | 最終稟議書完成通知 |
| Server → Client | `session_reset` | セッションリセット通知 |

---

## 7. データ構造

### 7.1 セッションデータ（メモリ上のみ）

| キー | 型 | 説明 |
|------|-----|------|
| `ai_status` | `dict[str, bool]` | 全 16 体の接続状態 |
| `discussion_active` | `bool` | 議論が進行中か |
| `messages` | `list[dict]` | チャットメッセージ履歴（全 16 体分） |
| `chart_images` | `list[dict]` | Base64 エンコードされたチャート画像 |
| `ensemble_state` | `dict` | 各陣営の内部合議状態（フェーズ、各役割の出力） |
| `proposals` | `list[Proposal]` | 提出された稟議書リスト |
| `final_report` | `dict \| None` | 最終承認された稟議書レポート |

### 7.2 メッセージデータ構造（v2.0 拡張）

```json
{
  "id": "uuid",
  "sender": "chatgpt-worker-2",
  "faction": "chatgpt",
  "role": "worker",
  "display_name": "ChatGPT 調査役#2",
  "content": "メッセージ本文",
  "timestamp": "2026-02-10T17:42:00",
  "type": "ai",
  "has_authority": false
}
```

### 7.3 稟議書（Proposal）データクラス

| フィールド | 型 | 説明 |
|-----------|-----|------|
| `id` | `str (UUID)` | 一意識別子 |
| `author` | `str` | 提出者の AI ID（**決裁権者のみ**） |
| `strategy` | `str` | 取引戦略 |
| `rationale` | `str` | 根拠（採用理由・不採用理由を含む） |
| `evidence_sources` | `list[str]` | 根拠の元となった調査役・監査役の AI ID |
| `votes` | `dict[str, str]` | `{決裁権者ID: "support" \| "oppose"}` |
| `status` | `str` | `pending / voting / approved / rejected` |

---

## 8. アンサンブルエンジン仕様

### 8.1 陣営内合議フロー

```
Phase 1: まとめ役が論点整理
    └→ チャート画像＋要件を整理し、分析の「問い」を定義
    └→ 調査役・監査役に指示を出す

Phase 2: 調査役（3体）が並列で提案
    └→ Worker-1: テクニカル優先の戦略
    └→ Worker-2: ファンダメンタルズ優先の戦略
    └→ Worker-3: リスク最小化優先の戦略

Phase 3: 監査役（3体）が反証
    └→ Critic-1: 前提条件の妥当性を検証
    └→ Critic-2: 反例・破綻シナリオを提示
    └→ Critic-3: リスク・コンプライアンス観点で指摘

Phase 4: まとめ役が統合
    └→ 調査役の根拠を比較
    └→ 監査役の反証を確認
    └→ 採用理由／不採用理由を明文化
    └→ 陣営としての結論を確定
```

### 8.2 中央議論フロー

陣営内合議が完了した後、決裁権者 4 名（ChatGPT リーダー、Gemini リーダー、Codex、Claude）が中央チャットで議論を行う。

1. 各リーダーが陣営の結論と根拠を発表
2. Codex がデータ分析・定量的妥当性をチェック
3. Claude が論理整合性・見落としを指摘
4. 決裁権者が必要に応じて稟議書を提出
5. 投票 → 満場一致なら承認 → ブラッシュアップ

### 8.3 システムプロンプト設計方針

各役割には以下の指示をシステムプロンプトに含める。

| 役割 | プロンプトの核心 |
|------|----------------|
| まとめ役 | 「あなたは陣営のリーダーです。調査役と監査役の出力を統合し、根拠採用制で結論を出してください。多数決は行わず、採用理由を必ず明文化してください。」 |
| 調査役 | 「あなたは調査・提案を担当します。指定された視点（テクニカル/ファンダメンタルズ/リスク等）から戦略を提案してください。稟議書や投票は行わないでください。」 |
| 監査役 | 「あなたは監査・反証を担当します。提案された戦略の弱点、前提の抜け、反例を指摘してください。稟議書や投票は行わないでください。」 |
| Codex | 「あなたはデータ分析の専門家です。議論に対して定量的な根拠やデータ分析の観点からチェックしてください。」 |
| Claude | 「あなたはリスク管理・総合判断の専門家です。議論全体の論理整合性を検証し、見落としを指摘してください。最終稟議書の統合も担当します。」 |

### 8.4 安全装置

- **最大ラウンド数:** 陣営内合議 5 ラウンド、中央議論 20 ラウンド
- **AI レスポンスタイムアウト:** 60 秒/体
- **強制終了ボタン:** ユーザーがいつでも全データ破棄可能
- **決裁権チェック:** 稟議・投票リクエストは決裁権者 ID のホワイトリストで検証

---

## 9. 開発ロードマップ

| Step | 内容 | ステータス | 主要タスク |
|------|------|-----------|-----------|
| 1 | プロジェクト構成・環境構築 | ✅ 完了 | ディレクトリ構成、config.py、requirements.txt |
| 2 | UI 基盤（チャット画面） | ✅ 完了 | 3 カラムレイアウト、チャットバブル、フェーズ切替 |
| 3 | AI 接続モジュール（16 体対応） | 🔄 要改修 | 16 体分のインスタンス生成、役割別プロンプト設定 |
| 4 | アンサンブルエンジン | 🆕 新規 | 陣営内合議フロー、並列実行、根拠採用制ロジック |
| 5 | 中央議論エンジン | 🔄 要改修 | 決裁権者のみの議論、権限チェック |
| 6 | UI 拡張（16 体対応） | 🔄 要改修 | 役割バッジ、陣営ポップアップ、オンライン数 16 体表示 |
| 7 | 稟議書生成・ブラッシュアップ | 🔄 要改修 | 根拠採用制の明文化、evidence_sources 対応 |
| 8 | 統合テスト・デプロイ | ⬜ 未着手 | 全フロー通しテスト、エラーハンドリング |

---

## 10. v1.0 → v2.0 変更差分サマリ

| 項目 | v1.0 | v2.0 |
|------|------|------|
| AI 総数 | 4 体 | **16 体** |
| 意思決定者数 | 4 体（全員） | **4 体（まとめ役のみ）** |
| 議論方式 | 単純ラウンドロビン | **陣営内合議 → 中央議論の 2 段階** |
| 意思決定方式 | 各 AI が自由に稟議 | **根拠採用制（まとめ役が統合）** |
| 新規モジュール | — | `ensemble_engine.py` |
| ステータス | 6 種 | **7 種**（「陣営内合議中」を追加） |
| メッセージ構造 | `{sender, content}` | `{sender, faction, role, has_authority, ...}` |

---

*以上*
